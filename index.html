<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>La Team</title>

<style>
:root{
  --bg1:#1f7a5a;
  --bg2:#0b3b6f;
  --accent:#ffb35c;
  --btn:#00c9a7;
  --btnText:#073;
  --card:rgba(255,255,255,0.12);
  --card2:rgba(0,0,0,0.24);
  --muted:rgba(255,255,255,0.86);
  --danger:#ff6b6b;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: Arial, sans-serif;
  color:#fff;
  min-height:100vh;
  background: linear-gradient(135deg, rgba(31,122,90,0.30), rgba(11,59,111,0.30)),
              url("./bg.jpg");
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}
.container{ max-width:980px; margin:auto; padding:16px; }
h1,h2{text-align:center;}
.card{
  background:var(--card);
  padding:16px;
  border-radius:14px;
  margin-bottom:14px;
}
label{display:block;margin-top:10px;color:var(--muted);}
input,select,button{
  width:100%;
  padding:12px;
  margin-top:6px;
  border-radius:10px;
  border:none;
  font-size:16px;
}
button{background:var(--btn);font-weight:700;cursor:pointer;}
button.secondary{background:rgba(255,255,255,0.16);color:#fff;}
button.danger{background:rgba(255,107,107,0.3);color:#fff;}
.hidden{display:none;}
.row{display:flex;gap:10px;}
.row>div{flex:1;}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;text-align:center;}
th{background:var(--card2);}
.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(0,0,0,0.18);
  font-size:13px;
}
</style>
</head>

<body>
<div class="container">

<h1>ðŸŽ¾ La Team</h1>

<div id="setup" class="card">
<h2>RÃ©glages</h2>

<label>Nombre de joueurs</label>
<select id="playerCount">
  <option value="4">4</option>
  <option value="6">6</option>
  <option value="8">8</option>
  <option value="12">12</option>
  <option value="16">16</option>
</select>

<div id="players"></div>

<label>Mode de jeu</label>
<select id="gameMode">
  <option value="americano">Americano</option>
  <option value="ladder">MontÃ©e / Descente</option>
</select>

<label>Total de points</label>
<input id="maxPoints" type="number" min="1" max="31" value="21"/>

<button onclick="startNewTournament()">DÃ©marrer</button>
</div>

<div id="game" class="hidden">
<div class="card">
<h2>Matchs</h2>
<div id="courts"></div>
<button onclick="nextMatch()" id="nextBtn" disabled>Round suivant</button>
</div>

<div class="card">
<h2>Classement</h2>
<table>
<thead>
<tr>
<th>Joueur</th><th>MJ</th><th>V</th><th>+</th><th>-</th><th>Diff</th>
</tr>
</thead>
<tbody id="ranking"></tbody>
</table>
</div>
</div>

<script>
/* -------------------- STATE -------------------- */
let state={
  mode:"americano",
  n:4,
  courts:1,
  maxPoints:21,
  totalRounds:0,
  players:[],
  schedule:[],
  matchIndex:0,
  validatedCourts:[],
  courtScores:[],
  results:[]
};

/* -------------------- HELPERS -------------------- */
function clamp(x,a,b){return Math.max(a,Math.min(b,x));}
function playerName(i){return state.players[i].name;}
function createInputs(){
  const div=document.getElementById("players");
  div.innerHTML="";
  for(let i=0;i<playerCount.value;i++){
    div.innerHTML+=`<input id="p${i}" placeholder="Joueur ${i+1}">`;
  }
}
playerCount.onchange=createInputs;
createInputs();

/* -------------------- AMERICANO -------------------- */
function buildScheduleAmericano(n){
  const rounds=[];
  const idx=[...Array(n).keys()];
  for(let r=0;r<n-1;r++){
    const shuffled=[...idx].sort(()=>Math.random()-0.5);
    rounds.push({
      rest:[],
      courts:[
        {teamA:[shuffled[0],shuffled[1]],teamB:[shuffled[2],shuffled[3]]}
      ]
    });
  }
  return rounds;
}

/* -------------------- START -------------------- */
function startNewTournament(){
  state.mode=gameMode.value;
  state.n=+playerCount.value;
  state.maxPoints=clamp(+maxPoints.value,1,31);
  state.players=[];
  for(let i=0;i<state.n;i++){
    state.players.push({
      name:document.getElementById("p"+i).value||("J"+(i+1)),
      mj:0,v:0,plus:0,minus:0
    });
  }
  state.totalRounds=state.n-1;
  state.schedule = (state.mode==="americano")
    ? buildScheduleAmericano(state.n)
    : []; // ladder arrive en PARTIE 2
  state.matchIndex=0;
  document.getElementById("setup").classList.add("hidden");
  document.getElementById("game").classList.remove("hidden");
  renderMatch();
  renderRanking();
}
/* -------------------- LADDER (MontÃ©e / Descente avec sÃ©paration des Ã©quipes) -------------------- */

function buildFirstRoundLadder(n){
  const idx=[...Array(n).keys()].sort(()=>Math.random()-0.5);
  const courts=[];
  for(let i=0;i<n;i+=4){
    courts.push({
      teamA:[idx[i],idx[i+1]],
      teamB:[idx[i+2],idx[i+3]]
    });
  }
  return {rest:[],courts};
}

function buildNextRoundLadder(prevCourts, prevResults){
  const courtsN = prevCourts.length;
  const last = courtsN - 1;

  const moved = Array.from({length:courtsN},()=>[]);

  for(let i=0;i<courtsN;i++){
    const c = prevCourts[i];
    const r = prevResults[i];
    if(!r){
      moved[i].push(c.teamA,c.teamB);
      continue;
    }
    const win = r.a > r.b ? c.teamA : c.teamB;
    const lose = r.a > r.b ? c.teamB : c.teamA;

    moved[Math.max(0,i-1)].push(win);
    moved[Math.min(last,i+1)].push(lose);
  }

  const newCourts=[];
  for(let i=0;i<courtsN;i++){
    if(moved[i].length<2){
      newCourts.push(prevCourts[i]);
      continue;
    }
    const [t1,t2]=moved[i];
    const cross=Math.random()<0.5;
    newCourts.push({
      teamA: cross ? [t1[0],t2[0]] : [t1[0],t2[1]],
      teamB: cross ? [t1[1],t2[1]] : [t1[1],t2[0]]
    });
  }
  return {rest:[],courts:newCourts};
}

/* -------------------- RENDER MATCH -------------------- */

function renderMatch(){
  if(state.matchIndex>=state.totalRounds){
    alert("Tournoi terminÃ©");
    return;
  }

  if(state.mode==="ladder" && !state.schedule[state.matchIndex]){
    const prev=state.schedule[state.matchIndex-1];
    const prevRes=state.results[state.matchIndex-1];
    state.schedule[state.matchIndex]=buildNextRoundLadder(prev.courts,prevRes);
  }

  const match=state.schedule[state.matchIndex];
  const courtsDiv=document.getElementById("courts");
  courtsDiv.innerHTML="";
  state.validatedCourts=[];
  state.courtScores=[];

  match.courts.forEach((c,idx)=>{
    courtsDiv.innerHTML+=`
      <div class="card">
        <b>Terrain ${idx+1}</b><br>
        ${playerName(c.teamA[0])}/${playerName(c.teamA[1])}
        vs
        ${playerName(c.teamB[0])}/${playerName(c.teamB[1])}
        <div class="row">
          <div><input type="number" id="a${idx}" value="0"></div>
          <div><input type="number" id="b${idx}" value="${state.maxPoints}"></div>
        </div>
        <button onclick="validateCourt(${idx})">Valider</button>
      </div>
    `;
    state.validatedCourts.push(false);
    state.courtScores.push({a:0,b:state.maxPoints});
  });
}

/* -------------------- VALIDATION -------------------- */

function validateCourt(i){
  const a=+document.getElementById("a"+i).value;
  const b=+document.getElementById("b"+i).value;
  if(a+b!==state.maxPoints||a===b){
    alert("Score invalide");
    return;
  }
  const court=state.schedule[state.matchIndex].courts[i];
  applyResult(court.teamA,court.teamB,a,b);
  if(!state.results[state.matchIndex])state.results[state.matchIndex]=[];
  state.results[state.matchIndex][i]={a,b};
  state.validatedCourts[i]=true;
  document.getElementById("nextBtn").disabled=!state.validatedCourts.every(Boolean);
  renderRanking();
}

function applyResult(teamA,teamB,a,b){
  teamA.forEach(p=>{
    state.players[p].mj++;
    state.players[p].plus+=a;
    state.players[p].minus+=b;
  });
  teamB.forEach(p=>{
    state.players[p].mj++;
    state.players[p].plus+=b;
    state.players[p].minus+=a;
  });
  (a>b?teamA:teamB).forEach(p=>state.players[p].v++);
}

/* -------------------- NEXT ROUND -------------------- */

function nextMatch(){
  if(!state.validatedCourts.every(Boolean))return;
  state.matchIndex++;
  document.getElementById("nextBtn").disabled=true;
  renderMatch();
}

/* -------------------- RANKING -------------------- */

function renderRanking(){
  const body=document.getElementById("ranking");
  body.innerHTML="";
  [...state.players].sort((a,b)=>{
    if(b.v!==a.v)return b.v-a.v;
    return (b.plus-b.minus)-(a.plus-a.minus);
  }).forEach(p=>{
    body.innerHTML+=`
      <tr>
        <td>${p.name}</td>
        <td>${p.mj}</td>
        <td>${p.v}</td>
        <td>${p.plus}</td>
        <td>${p.minus}</td>
        <td>${p.plus-p.minus}</td>
      </tr>
    `;
  });
}

/* -------------------- INIT LADDER -------------------- */
if(state.mode==="ladder"){
  state.schedule=[buildFirstRoundLadder(state.n)];
}
</script>
</body>
</html>
