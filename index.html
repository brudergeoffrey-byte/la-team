<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>La Team</title>

<style>
:root{
  --bg1:#1f7a5a;
  --bg2:#0b3b6f;
  --accent:#ffb35c;
  --btn:#00c9a7;
  --btnText:#073;
  --card:rgba(255,255,255,0.12);
  --card2:rgba(0,0,0,0.24);
  --muted:rgba(255,255,255,0.86);
  --danger:#ff6b6b;
}
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family: Arial, sans-serif;
  color:#fff;
  min-height:100vh;

  /* âœ… Image bg.jpg + overlay (rÃ©duis 0.28 -> 0.18 pour voir plus l'image) */
  background:
    linear-gradient(135deg, rgba(31,122,90,0.22), rgba(11,59,111,0.22)),
    url("./bg.jpg?v=1"),
    url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 1200'>\
<defs>\
  <radialGradient id='g' cx='50%25' cy='45%25' r='60%25'>\
    <stop offset='0%25' stop-color='white' stop-opacity='0.09'/>\
    <stop offset='100%25' stop-color='white' stop-opacity='0'/>\
  </radialGradient>\
</defs>\
<circle cx='560' cy='520' r='520' fill='url(%23g)'/>\
<rect x='160' y='220' width='880' height='760' rx='26' fill='none' stroke='white' stroke-opacity='0.06' stroke-width='18'/>\
<line x1='600' y1='220' x2='600' y2='980' stroke='white' stroke-opacity='0.05' stroke-width='12'/>\
<line x1='160' y1='600' x2='1040' y2='600' stroke='white' stroke-opacity='0.05' stroke-width='12'/>\
</svg>");
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}

.container{ max-width: 980px; margin:auto; padding: 16px; }
h1,h2{ text-align:center; margin:10px 0 14px; }
.small{ text-align:center; color: var(--muted); margin-top:-6px; margin-bottom:10px; font-size:14px; }

.card{
  background: var(--card);
  padding: 16px;
  border-radius: 14px;
  margin-bottom: 14px;
  backdrop-filter: blur(2px);
}

label{ display:block; margin-top:10px; color:var(--muted); font-size:14px; }

input, select, button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border-radius:10px;
  border:none;
  font-size:16px;
}

button{
  background: var(--btn);
  color: var(--btnText);
  font-weight: 800;
  cursor: pointer;
}
button.secondary{
  background: rgba(255,255,255,0.16);
  color:#fff;
}
button.danger{
  background: rgba(255,107,107,0.24);
  color:#fff;
}
button:disabled{ opacity:0.5; cursor:not-allowed; }

.row{ display:flex; gap:10px; }
.row>div{ flex:1; }

.hidden{ display:none; }

table{ width:100%; border-collapse:collapse; }
th,td{ padding:8px; text-align:center; }
th{ background: var(--card2); }

.badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(0,0,0,0.18);
  font-size:13px;
  color:var(--muted);
}
hr.sep{ border:none; height:1px; background:rgba(255,255,255,0.14); margin:12px 0; }

/* Barre dâ€™action */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.brand{
  font-weight:900;
  font-size:22px;
  display:flex;
  align-items:center;
  gap:10px;
}
.brand .dot{
  width:10px; height:10px; border-radius:50%;
  background: var(--accent);
  box-shadow: 0 0 0 6px rgba(255,179,92,0.18);
}
.topbar .actions{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
  justify-content:flex-end;
}
.topbar button{ width:auto; padding:10px 12px; border-radius:12px; }

.savesBox{
  background: rgba(0,0,0,0.10);
  border-radius: 12px;
  padding: 12px;
  margin-top: 12px;
}
@media (max-width:520px){
  .topbar{ align-items:flex-start; }
  .topbar .actions button{ padding:9px 10px; font-size:14px; }
}
</style>
</head>

<body>
<div class="container">

  <div class="topbar">
    <div class="brand"><span class="dot"></span> La Team</div>
    <div class="actions">
      <button class="secondary" onclick="saveAs()">ğŸ’¾ Sauverâ€¦</button>
      <button class="secondary" onclick="openLoad()">ğŸ“‚ Charger</button>
      <button class="secondary" onclick="goSetup()">âš™ï¸ Menu</button>
      <button class="danger" onclick="resetAll()">ğŸ§¹ Effacer</button>
    </div>
  </div>

  <!-- SETUP -->
  <div id="setup" class="card">
    <h2>RÃ©glages</h2>
    <div class="small">Choisis le format puis dÃ©marre.</div>

    <label>Nombre de joueurs</label>
    <select id="playerCount">
      <option value="4">4 joueurs</option>
      <option value="6">6 joueurs</option>
      <option value="8">8 joueurs</option>
      <option value="12">12 joueurs</option>
      <option value="16">16 joueurs</option>
    </select>

    <div id="courtWrap" style="margin-top:10px; display:none;">
      <label>Nombre de terrains</label>
      <select id="courtCount"></select>
      <div class="small" style="text-align:left; margin-top:6px;">
        Moins de terrains = des joueurs au repos.
      </div>
    </div>

    <div id="players"></div>

    <label>Points pour gagner</label>
    <select id="maxPoints">
      <option>11</option>
      <option selected>21</option>
      <option>31</option>
    </select>

    <div class="row">
      <div><button onclick="start()">DÃ©marrer</button></div>
      <div><button class="secondary" onclick="openLoad()">ğŸ“‚ Charger</button></div>
    </div>

    <div class="savesBox">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <div><b>Sauvegardes</b> <span class="badge" id="saveCount">0</span></div>
        <button class="secondary" style="width:auto; padding:8px 10px;" onclick="refreshSaves()">â†»</button>
      </div>

      <label style="margin-top:10px;">Choisir une sauvegarde</label>
      <select id="saveSelect"></select>

      <div class="row" style="margin-top:8px;">
        <div><button class="secondary" onclick="loadSelected()">Charger</button></div>
        <div><button class="danger" onclick="deleteSelected()">Supprimer</button></div>
      </div>

      <div class="small" id="saveHint" style="margin-top:10px;"></div>
      <div class="small" style="margin-top:6px;">âœ… Offline OK (via sw.js)</div>
    </div>
  </div>

  <!-- GAME -->
  <div id="game" class="hidden">
    <div class="card">
      <h2>Matchs</h2>
      <div class="small" id="progressText"></div>
      <div class="small" id="restText"></div>

      <div id="courts"></div>

      <div class="row">
        <div><button id="undoBtn" class="secondary" onclick="undo()" disabled>â†©ï¸ Retour</button></div>
        <div><button id="nextBtn" onclick="nextRound()" disabled>Round suivant</button></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div><button class="secondary" onclick="saveAs()">ğŸ’¾ Sauverâ€¦</button></div>
        <div><button class="secondary" onclick="openLoad()">ğŸ“‚ Charger</button></div>
      </div>
      <div class="small" id="saveStatus" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <h2>Classement</h2>
      <table>
        <thead>
          <tr>
            <th>Joueur</th>
            <th>MJ</th>
            <th>V</th>
            <th>+</th>
            <th>-</th>
            <th>Diff</th>
          </tr>
        </thead>
        <tbody id="ranking"></tbody>
      </table>
    </div>
  </div>

  <!-- FINISH -->
  <div id="finish" class="hidden">
    <div class="card">
      <h2>âœ… Fini !</h2>
      <div class="small">Classement final</div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Joueur</th>
            <th>MJ</th>
            <th>V</th>
            <th>+</th>
            <th>-</th>
            <th>Diff</th>
          </tr>
        </thead>
        <tbody id="finalRanking"></tbody>
      </table>

      <hr class="sep">
      <button onclick="restartSame()">ğŸ” Rejouer (mÃªmes joueurs)</button>

      <hr class="sep">
      <div class="row">
        <div><button class="secondary" onclick="saveAs()">ğŸ’¾ Sauverâ€¦</button></div>
        <div><button class="secondary" onclick="openLoad()">ğŸ“‚ Charger</button></div>
      </div>

      <hr class="sep">
      <button class="secondary" onclick="goSetup()">Retour menu</button>
    </div>
  </div>

</div>

<script>
/* ========= Multi-sauvegardes ========= */
const SAVES_INDEX_KEY = "la-team-saves-index-v1";
const SAVE_PREFIX = "la-team-save-v1:";

function getIndex(){
  try{
    const raw = localStorage.getItem(SAVES_INDEX_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function setIndex(arr){
  try{ localStorage.setItem(SAVES_INDEX_KEY, JSON.stringify(arr)); }catch(e){}
}
function fmtDate(ts){ try{ return new Date(ts).toLocaleString(); }catch(e){ return ""; } }
function makeId(){ return String(Date.now()) + "-" + Math.random().toString(16).slice(2,10); }

/* ========= State ========= */
let state = {
  n: 4,
  courts: 1,
  maxPoints: 21,
  players: [],
  schedule: [],
  matchIndex: 0,
  validatedCourts: [],
  history: []
};

const setupEl  = document.getElementById("setup");
const gameEl   = document.getElementById("game");
const finishEl = document.getElementById("finish");

const playerCountEl = document.getElementById("playerCount");
const playersDiv    = document.getElementById("players");
const maxPointsEl   = document.getElementById("maxPoints");
const courtWrap     = document.getElementById("courtWrap");
const courtCountEl  = document.getElementById("courtCount");

const courtsDiv     = document.getElementById("courts");
const rankingBody   = document.getElementById("ranking");
const finalBody     = document.getElementById("finalRanking");

const undoBtn       = document.getElementById("undoBtn");
const nextBtn       = document.getElementById("nextBtn");
const progressText  = document.getElementById("progressText");
const restText      = document.getElementById("restText");
const saveStatus    = document.getElementById("saveStatus");

const saveSelect    = document.getElementById("saveSelect");
const saveHint      = document.getElementById("saveHint");
const saveCount     = document.getElementById("saveCount");

function deepClone(o){ return JSON.parse(JSON.stringify(o)); }
function showSetup(){ gameEl.classList.add("hidden"); finishEl.classList.add("hidden"); setupEl.classList.remove("hidden"); window.scrollTo(0,0); }
function showGame(){ setupEl.classList.add("hidden"); finishEl.classList.add("hidden"); gameEl.classList.remove("hidden"); window.scrollTo(0,0); }
function showFinish(){ setupEl.classList.add("hidden"); gameEl.classList.add("hidden"); finishEl.classList.remove("hidden"); window.scrollTo(0,0); }

function maxCourtsForN(n){
  if(n===4) return 1;
  if(n===6) return 1;
  if(n===8) return 2;
  if(n===12) return 3;
  if(n===16) return 4;
  return 1;
}
function fillCourts(n, selected){
  const max = maxCourtsForN(n);
  courtCountEl.innerHTML = "";
  for(let c=max; c>=1; c--){
    const o = document.createElement("option");
    o.value = String(c);
    o.textContent = `${c} terrain${c>1?"s":""}`;
    courtCountEl.appendChild(o);
  }
  courtCountEl.value = String(selected || max);
}

function createInputs(){
  playersDiv.innerHTML = "";
  const n = +playerCountEl.value;
  for(let i=0;i<n;i++){
    playersDiv.innerHTML += `<input placeholder="Joueur ${i+1}" id="p${i}">`;
  }
}
function updateCourtUI(){
  const n = +playerCountEl.value;
  const max = maxCourtsForN(n);
  courtWrap.style.display = (max>1) ? "block" : "none";
  if(max>1) fillCourts(n, +courtCountEl.value || max);
}

playerCountEl.addEventListener("change", ()=>{ createInputs(); updateCourtUI(); });

function scoreOptions(){
  let s="";
  for(let i=0;i<=state.maxPoints;i++) s += `<option value="${i}">${i}</option>`;
  return s;
}
function playerName(i){ return state.players[i].name; }
function sortPlayers(arr){
  return [...arr].sort((a,b)=>{
    const da = a.plus - a.minus;
    const db = b.plus - b.minus;
    if(b.v !== a.v) return b.v - a.v;
    if(db !== da) return db - da;
    return b.plus - a.plus;
  });
}

/* ========= Planning (Americano simple) ========= */
function scheduleAmericano(n, courtsChosen){
  let arr = Array.from({length:n}, (_,i)=>i);
  const max = Math.floor(n/4) || 1;
  const courtsUsed = Math.max(1, Math.min(courtsChosen || max, max));
  const rounds = [];

  for(let r=0;r<n-1;r++){
    const pairs=[];
    for(let i=0;i<n/2;i++) pairs.push([arr[i], arr[n-1-i]]);

    const courts=[];
    for(let k=0;k<courtsUsed;k++){
      const p1=pairs[2*k], p2=pairs[2*k+1];
      if(!p1 || !p2) break;
      courts.push({teamA:p1, teamB:p2});
    }
    const rest = pairs.slice(courts.length*2).flat();
    rounds.push({courts, rest});

    const fixed = arr[0];
    const rot = arr.slice(1);
    rot.unshift(rot.pop());
    arr = [fixed, ...rot];
  }
  return rounds;
}
function buildSchedule(n, courts){
  return scheduleAmericano(n, courts);
}

/* ========= Saves UI ========= */
function refreshSaves(){
  const idx = getIndex();
  saveCount.textContent = String(idx.length);

  saveSelect.innerHTML = "";
  if(idx.length === 0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Aucune sauvegarde";
    saveSelect.appendChild(opt);
    saveSelect.disabled = true;
    saveHint.textContent = "Sauvegarde un tournoi avec Â« ğŸ’¾ Sauverâ€¦ Â».";
    return;
  }
  saveSelect.disabled = false;
  for(const s of idx){
    const opt = document.createElement("option");
    opt.value = s.id;
    opt.textContent = `${s.name} â€” ${s.n}J â€¢ ${s.courts}T â€¢ round ${s.round}/${s.total} â€¢ ${fmtDate(s.savedAt)}`;
    saveSelect.appendChild(opt);
  }
  saveHint.textContent = "Choisis une sauvegarde puis Charger/Supprimer.";
}

function canSave(){
  return state.players && state.players.length>0 && state.schedule && state.schedule.length>0;
}
function saveToSlot(id, name){
  const payload = deepClone(state);
  const savedAt = Date.now();
  try{
    localStorage.setItem(SAVE_PREFIX+id, JSON.stringify(payload));
    const total = payload.schedule.length;
    const round = Math.min(payload.matchIndex+1, total);
    const meta = { id, name, savedAt, n: payload.n, courts: payload.courts, round, total };
    const idx = getIndex();
    const i = idx.findIndex(x=>x.id===id);
    if(i>=0) idx[i]=meta; else idx.unshift(meta);
    idx.sort((a,b)=>(b.savedAt||0)-(a.savedAt||0));
    setIndex(idx);
    return true;
  }catch(e){
    alert("âŒ Impossible de sauvegarder (stockage plein ?).");
    return false;
  }
}

function saveAs(){
  if(!canSave()){
    alert("â„¹ï¸ DÃ©marre un tournoi avant de sauvegarder.");
    return;
  }
  const defaultName = `Tournoi ${fmtDate(Date.now())}`;
  const name = (prompt("Nom de la sauvegarde :", defaultName) || "").trim();
  if(!name) return;

  const idx = getIndex();
  const existing = idx.find(x => (x.name||"").toLowerCase() === name.toLowerCase());
  const id = existing ? existing.id : makeId();

  if(existing){
    if(!confirm(`"${existing.name}" existe dÃ©jÃ .\nÃ‰craser ?`)) return;
  }
  if(saveToSlot(id, name)){
    refreshSaves();
    saveStatus.textContent = `âœ… SauvegardÃ© : ${name}`;
  }
}

function loadFromSlot(id){
  try{
    const raw = localStorage.getItem(SAVE_PREFIX+id);
    if(!raw) return false;
    const s = JSON.parse(raw);
    if(!s || !s.players || !s.schedule) return false;
    state = s;
    return true;
  }catch(e){ return false; }
}

function openLoad(){
  refreshSaves();
  showSetup();
  setTimeout(()=>saveSelect.scrollIntoView({behavior:"smooth", block:"center"}), 50);
}

function loadSelected(){
  const id = saveSelect.value;
  if(!id){ alert("Aucune sauvegarde."); return; }
  if(!loadFromSlot(id)){
    alert("âŒ Sauvegarde introuvable/corrompue.");
    refreshSaves();
    return;
  }
  if(state.matchIndex >= state.schedule.length){
    renderFinish();
    showFinish();
  }else{
    showGame();
    renderMatch();
    renderRanking();
  }
  refreshSaves();
}

function deleteSelected(){
  const id = saveSelect.value;
  if(!id){ alert("Aucune sauvegarde."); return; }
  if(!confirm("Supprimer cette sauvegarde ?")) return;
  try{ localStorage.removeItem(SAVE_PREFIX+id); }catch(e){}
  setIndex(getIndex().filter(x=>x.id!==id));
  refreshSaves();
}

/* ========= Game ========= */
function start(){
  state.n = +playerCountEl.value;
  state.maxPoints = +maxPointsEl.value;

  const max = maxCourtsForN(state.n);
  state.courts = (max>1) ? (+courtCountEl.value || max) : 1;

  state.players = [];
  for(let i=0;i<state.n;i++){
    const name = (document.getElementById("p"+i).value || ("J"+(i+1))).trim();
    state.players.push({ name, mj:0, v:0, plus:0, minus:0 });
  }

  state.schedule = buildSchedule(state.n, state.courts);
  state.matchIndex = 0;
  state.validatedCourts = [];
  state.history = [];

  saveStatus.textContent = "";
  showGame();
  renderMatch();
  renderRanking();
}

function renderMatch(){
  if(state.matchIndex >= state.schedule.length){
    renderFinish();
    showFinish();
    return;
  }

  const match = state.schedule[state.matchIndex];
  const total = state.schedule.length;

  progressText.innerHTML =
    `<span class="badge">Round ${state.matchIndex+1} / ${total}</span>
     <span class="badge">${state.n} joueurs â€¢ ${state.courts} terrain(s)</span>`;

  restText.innerHTML = (match.rest && match.rest.length)
    ? `Repos : <b>${match.rest.map(i=>playerName(i)).join("</b> &nbsp; <b>")}</b>`
    : "";

  if(!Array.isArray(state.validatedCourts) || state.validatedCourts.length !== match.courts.length){
    state.validatedCourts = Array(match.courts.length).fill(false);
  }

  courtsDiv.innerHTML = "";
  match.courts.forEach((c, idx)=>{
    const disabled = state.validatedCourts[idx];
    courtsDiv.innerHTML += `
      <div class="card" style="margin-bottom:12px;">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
          <div><b>Terrain ${idx+1}</b></div>
          ${disabled ? `<span class="badge">ValidÃ©</span>` : ``}
        </div>

        <div style="margin-top:8px;">
          <b>${playerName(c.teamA[0])}</b> / <b>${playerName(c.teamA[1])}</b>
          &nbsp; vs &nbsp;
          <b>${playerName(c.teamB[0])}</b> / <b>${playerName(c.teamB[1])}</b>
        </div>

        <div class="row" style="margin-top:10px;">
          <div><select id="scoreA_${idx}" ${disabled?"disabled":""}>${scoreOptions()}</select></div>
          <div><select id="scoreB_${idx}" ${disabled?"disabled":""}>${scoreOptions()}</select></div>
        </div>

        <button style="margin-top:10px;" onclick="validate(${idx})" ${disabled?"disabled":""}>Valider</button>
      </div>
    `;
  });

  nextBtn.disabled = !state.validatedCourts.every(Boolean);
  undoBtn.disabled = state.history.length === 0;
}

function applyResult(teamA, teamB, a, b){
  for(const p of teamA){
    state.players[p].mj++;
    state.players[p].plus += a;
    state.players[p].minus += b;
  }
  for(const p of teamB){
    state.players[p].mj++;
    state.players[p].plus += b;
    state.players[p].minus += a;
  }
  if(a>b) for(const p of teamA) state.players[p].v++;
  if(b>a) for(const p of teamB) state.players[p].v++;
}

function validate(idx){
  const match = state.schedule[state.matchIndex];
  const court = match.courts[idx];

  state.history.push(deepClone({
    players: state.players,
    matchIndex: state.matchIndex,
    validatedCourts: state.validatedCourts
  }));

  const a = +document.getElementById(`scoreA_${idx}`).value;
  const b = +document.getElementById(`scoreB_${idx}`).value;

  applyResult(court.teamA, court.teamB, a, b);

  state.validatedCourts[idx] = true;
  renderRanking();
  renderMatch();
}

function nextRound(){
  if(!state.validatedCourts.every(Boolean)) return;
  state.matchIndex++;
  state.validatedCourts = [];
  renderMatch();
}

function undo(){
  if(!state.history.length) return;
  const prev = state.history.pop();
  state.players = prev.players;
  state.matchIndex = prev.matchIndex;
  state.validatedCourts = prev.validatedCourts;
  renderRanking();
  renderMatch();
}

function renderRanking(){
  rankingBody.innerHTML = "";
  const sorted = sortPlayers(state.players);
  for(const p of sorted){
    rankingBody.innerHTML += `
      <tr>
        <td>${p.name}</td>
        <td>${p.mj}</td>
        <td>${p.v}</td>
        <td>${p.plus}</td>
        <td>${p.minus}</td>
        <td>${p.plus - p.minus}</td>
      </tr>
    `;
  }
}

function renderFinish(){
  finalBody.innerHTML = "";
  const sorted = sortPlayers(state.players);
  sorted.forEach((p,i)=>{
    finalBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${p.name}</td>
        <td>${p.mj}</td>
        <td>${p.v}</td>
        <td>${p.plus}</td>
        <td>${p.minus}</td>
        <td>${p.plus - p.minus}</td>
      </tr>
    `;
  });
}

function restartSame(){
  const names = state.players.map(p=>p.name);
  const n = state.n;
  const courts = state.courts;

  state.players = names.map(name=>({name, mj:0, v:0, plus:0, minus:0}));
  state.schedule = buildSchedule(n, courts);
  state.matchIndex = 0;
  state.validatedCourts = [];
  state.history = [];
  showGame();
  renderMatch();
  renderRanking();
}

function goSetup(){
  playerCountEl.value = String(state.n || 4);
  createInputs();
  updateCourtUI();
  if(state.players && state.players.length){
    for(let i=0;i<Math.min(state.players.length, +playerCountEl.value);i++){
      const inp = document.getElementById("p"+i);
      if(inp) inp.value = state.players[i].name || "";
    }
    maxPointsEl.value = String(state.maxPoints || 21);
  }
  refreshSaves();
  showSetup();
}

function resetAll(){
  if(!confirm("Tout effacer (application + sauvegardes) ?")) return;

  const idx = getIndex();
  for(const s of idx){
    try{ localStorage.removeItem(SAVE_PREFIX+s.id); }catch(e){}
  }
  try{ localStorage.removeItem(SAVES_INDEX_KEY); }catch(e){}
  location.reload();
}

/* ========= INIT ========= */
(function init(){
  createInputs();
  updateCourtUI();
  refreshSaves();
  showSetup();
})();
</script>

<!-- âœ… OFFLINE : enregistre le service worker -->
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>

</body>
</html>
